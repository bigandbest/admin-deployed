import { useState, useEffect } from "react";
import { FaPlus, FaTimes, FaUpload, FaWarehouse } from "react-icons/fa";

const ProductModal = ({ 
  isOpen, 
  onClose, 
  product = null, 
  categories = [], 
  subcategories = [], 
  groups = [],
  warehouses = [],
  onSave 
}) => {
  const isEditMode = !!product;
  
  // Form state
  const [formData, setFormData] = useState({
    name: '',
    description: '',
    price: '',
    old_price: '',
    stock: '',
    category_id: '',
    subcategory_id: '',
    group_id: '',
    uom: '',
    rating: '',
    active: true,
    featured: false,
    popular: false,
    most_orders: false,
    top_rating: false,
    limited_product: false,
    seasonal_product: false,
    international_product: false,
    top_sale: false,
    is_global: false,
    in_stock: true,
    enquiry: false,
    warehouse_mapping_type: 'nationwide',
    primary_warehouses: [],
    fallback_warehouses: [],
    enable_fallback: true,
    warehouse_notes: ''
  });

  const [displayImageFile, setDisplayImageFile] = useState(null);
  const [imageFiles, setImageFiles] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  // Initialize form data when product changes
  useEffect(() => {
    if (product) {
      setFormData({
        name: product.name || '',
        description: product.description || '',
        price: product.price || '',
        old_price: product.old_price || '',
        stock: product.stock || '',
        category_id: product.category_id || '',
        subcategory_id: product.subcategory_id || '',
        group_id: product.group_id || '',
        uom: product.uom || '',
        rating: product.rating || '',
        active: product.active || true,
        featured: product.featured || false,
        popular: product.popular || false,
        most_orders: product.most_orders || false,
        top_rating: product.top_rating || false,
        limited_product: product.limited_product || false,
        seasonal_product: product.seasonal_product || false,
        international_product: product.international_product || false,
        top_sale: product.top_sale || false,
        is_global: product.is_global || false,
        in_stock: product.in_stock || true,
        enquiry: product.enquiry || false,
        warehouse_mapping_type: product.warehouse_mapping_type || 'nationwide',
        primary_warehouses: product.primary_warehouses || [],
        fallback_warehouses: product.fallback_warehouses || [],
        enable_fallback: product.enable_fallback !== false,
        warehouse_notes: product.warehouse_notes || ''
      });
    } else {
      // Reset for new product
      setFormData({
        name: '',
        description: '',
        price: '',
        old_price: '',
        stock: '',
        category_id: '',
        subcategory_id: '',
        group_id: '',
        uom: '',
        rating: '',
        active: true,
        featured: false,
        popular: false,
        most_orders: false,
        top_rating: false,
        limited_product: false,
        seasonal_product: false,
        international_product: false,
        top_sale: false,
        is_global: false,
        in_stock: true,
        enquiry: false,
        warehouse_mapping_type: 'nationwide',
        primary_warehouses: [],
        fallback_warehouses: [],
        enable_fallback: true,
        warehouse_notes: ''
      });
    }\n  }, [product]);\n\n  // Filter subcategories and groups based on selected category/subcategory\n  const filteredSubcategories = subcategories.filter(\n    s => !formData.category_id || s.category_id?.toString() === formData.category_id\n  );\n  \n  const filteredGroups = groups.filter(\n    g => !formData.subcategory_id || g.subcategory_id?.toString() === formData.subcategory_id\n  );\n\n  const zonalWarehouses = warehouses.filter(w => w.type === 'zonal');\n  const divisionWarehouses = warehouses.filter(w => w.type === 'division');\n\n  const handleInputChange = (field, value) => {\n    setFormData(prev => ({ ...prev, [field]: value }));\n    \n    // Clear dependent fields\n    if (field === 'category_id') {\n      setFormData(prev => ({ ...prev, subcategory_id: '', group_id: '' }));\n    } else if (field === 'subcategory_id') {\n      setFormData(prev => ({ ...prev, group_id: '' }));\n    }\n  };\n\n  const handleWarehouseToggle = (warehouseId, type) => {\n    const field = type === 'primary' ? 'primary_warehouses' : 'fallback_warehouses';\n    setFormData(prev => ({\n      ...prev,\n      [field]: prev[field].includes(warehouseId)\n        ? prev[field].filter(id => id !== warehouseId)\n        : [...prev[field], warehouseId]\n    }));\n  };\n\n  const handleImageUpload = (file, type) => {\n    if (type === 'display') {\n      setDisplayImageFile(file);\n    } else {\n      setImageFiles(prev => [...prev, file]);\n    }\n  };\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    setLoading(true);\n    setError('');\n\n    try {\n      // Validate required fields\n      if (!formData.name || !formData.price || !formData.category_id) {\n        throw new Error('Name, price, and category are required');\n      }\n\n      // Prepare form data for submission\n      const submitData = {\n        ...formData,\n        price: parseFloat(formData.price) || 0,\n        old_price: parseFloat(formData.old_price) || 0,\n        stock: parseInt(formData.stock) || 0,\n        rating: parseFloat(formData.rating) || 0,\n        category_id: parseInt(formData.category_id),\n        subcategory_id: formData.subcategory_id ? parseInt(formData.subcategory_id) : null,\n        group_id: formData.group_id ? parseInt(formData.group_id) : null,\n      };\n\n      await onSave(submitData, displayImageFile, imageFiles, isEditMode ? product.id : null);\n      onClose();\n    } catch (err) {\n      setError(err.message || 'Failed to save product');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  if (!isOpen) return null;\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm\">\n      <div className=\"bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-6xl w-full max-h-[95vh] overflow-hidden mx-4\">\n        {/* Header */}\n        <div className=\"p-6 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-slate-800 dark:to-slate-900\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-3\">\n              <div className=\"w-10 h-10 rounded-xl bg-gradient-to-tr from-blue-500 to-indigo-600 flex items-center justify-center\">\n                <FaPlus className=\"w-5 h-5 text-white\" />\n              </div>\n              <div>\n                <h2 className=\"text-2xl font-bold text-slate-900 dark:text-white\">\n                  {isEditMode ? 'Edit Product' : 'Add New Product'}\n                </h2>\n                <p className=\"text-sm text-slate-600 dark:text-slate-400\">\n                  {isEditMode ? 'Update product information' : 'Create a new product listing'}\n                </p>\n              </div>\n            </div>\n            <button\n              onClick={onClose}\n              className=\"w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 transition-colors\"\n            >\n              <FaTimes className=\"w-5 h-5\" />\n            </button>\n          </div>\n        </div>\n\n        <form onSubmit={handleSubmit} className=\"flex flex-col h-[calc(95vh-120px)]\">\n          <div className=\"flex-1 overflow-y-auto p-6\">\n            {/* Error Display */}\n            {error && (\n              <div className=\"mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-xl\">\n                <p className=\"text-red-700 dark:text-red-300 font-medium\">{error}</p>\n              </div>\n            )}\n\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-8\">\n              {/* Left Column - Basic Information */}\n              <div className=\"space-y-6\">\n                <div className=\"bg-slate-50 dark:bg-slate-800/50 p-6 rounded-xl\">\n                  <h3 className=\"text-lg font-semibold text-slate-900 dark:text-white mb-4\">\n                    Basic Information\n                  </h3>\n                  \n                  {/* Product Name */}\n                  <div className=\"mb-4\">\n                    <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2\">\n                      Product Name *\n                    </label>\n                    <input\n                      type=\"text\"\n                      value={formData.name}\n                      onChange={(e) => handleInputChange('name', e.target.value)}\n                      className=\"w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:text-white\"\n                      placeholder=\"Enter product name\"\n                      required\n                    />\n                  </div>\n\n                  {/* Description */}\n                  <div className=\"mb-4\">\n                    <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2\">\n                      Description\n                    </label>\n                    <textarea\n                      value={formData.description}\n                      onChange={(e) => handleInputChange('description', e.target.value)}\n                      rows={3}\n                      className=\"w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:text-white\"\n                      placeholder=\"Enter product description\"\n                    />\n                  </div>\n\n                  {/* Price and Stock */}\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <div>\n                      <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2\">\n                        Price (‚Çπ) *\n                      </label>\n                      <input\n                        type=\"number\"\n                        step=\"0.01\"\n                        value={formData.price}\n                        onChange={(e) => handleInputChange('price', e.target.value)}\n                        className=\"w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:text-white\"\n                        placeholder=\"0.00\"\n                        required\n                      />\n                    </div>\n                    <div>\n                      <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2\">\n                        Old Price (‚Çπ)\n                      </label>\n                      <input\n                        type=\"number\"\n                        step=\"0.01\"\n                        value={formData.old_price}\n                        onChange={(e) => handleInputChange('old_price', e.target.value)}\n                        className=\"w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:text-white\"\n                        placeholder=\"0.00\"\n                      />\n                    </div>\n                  </div>\n\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mt-4\">\n                    <div>\n                      <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2\">\n                        Stock Quantity\n                      </label>\n                      <input\n                        type=\"number\"\n                        value={formData.stock}\n                        onChange={(e) => handleInputChange('stock', e.target.value)}\n                        className=\"w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:text-white\"\n                        placeholder=\"0\"\n                      />\n                    </div>\n                    <div>\n                      <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2\">\n                        Unit of Measure\n                      </label>\n                      <input\n                        type=\"text\"\n                        value={formData.uom}\n                        onChange={(e) => handleInputChange('uom', e.target.value)}\n                        className=\"w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:text-white\"\n                        placeholder=\"kg, pcs, ltr\"\n                      />\n                    </div>\n                  </div>\n                </div>\n\n                {/* Category Selection */}\n                <div className=\"bg-slate-50 dark:bg-slate-800/50 p-6 rounded-xl\">\n                  <h3 className=\"text-lg font-semibold text-slate-900 dark:text-white mb-4\">\n                    Category & Classification\n                  </h3>\n                  \n                  <div className=\"space-y-4\">\n                    {/* Category */}\n                    <div>\n                      <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2\">\n                        Category *\n                      </label>\n                      <select\n                        value={formData.category_id}\n                        onChange={(e) => handleInputChange('category_id', e.target.value)}\n                        className=\"w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:text-white\"\n                        required\n                      >\n                        <option value=\"\">Select Category</option>\n                        {categories.map(category => (\n                          <option key={category.id} value={category.id}>\n                            {category.name}\n                          </option>\n                        ))}\n                      </select>\n                    </div>\n\n                    {/* Subcategory */}\n                    <div>\n                      <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2\">\n                        Subcategory\n                      </label>\n                      <select\n                        value={formData.subcategory_id}\n                        onChange={(e) => handleInputChange('subcategory_id', e.target.value)}\n                        className=\"w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:text-white\"\n                        disabled={!formData.category_id}\n                      >\n                        <option value=\"\">Select Subcategory</option>\n                        {filteredSubcategories.map(subcategory => (\n                          <option key={subcategory.id} value={subcategory.id}>\n                            {subcategory.name}\n                          </option>\n                        ))}\n                      </select>\n                    </div>\n\n                    {/* Group */}\n                    <div>\n                      <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2\">\n                        Group\n                      </label>\n                      <select\n                        value={formData.group_id}\n                        onChange={(e) => handleInputChange('group_id', e.target.value)}\n                        className=\"w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:text-white\"\n                        disabled={!formData.subcategory_id}\n                      >\n                        <option value=\"\">Select Group</option>\n                        {filteredGroups.map(group => (\n                          <option key={group.id} value={group.id}>\n                            {group.name}\n                          </option>\n                        ))}\n                      </select>\n                    </div>\n                  </div>\n                </div>\n              </div>\n\n              {/* Right Column - Settings and Warehouse */}\n              <div className=\"space-y-6\">\n                {/* Product Flags */}\n                <div className=\"bg-slate-50 dark:bg-slate-800/50 p-6 rounded-xl\">\n                  <h3 className=\"text-lg font-semibold text-slate-900 dark:text-white mb-4\">\n                    Product Settings\n                  </h3>\n                  \n                  <div className=\"grid grid-cols-2 gap-3\">\n                    {[\n                      { key: 'active', label: 'Active' },\n                      { key: 'featured', label: 'Featured' },\n                      { key: 'popular', label: 'Popular' },\n                      { key: 'most_orders', label: 'Most Orders' },\n                      { key: 'top_rating', label: 'Top Rating' },\n                      { key: 'limited_product', label: 'Limited' },\n                      { key: 'seasonal_product', label: 'Seasonal' },\n                      { key: 'international_product', label: 'International' },\n                      { key: 'top_sale', label: 'Top Sale' },\n                      { key: 'is_global', label: 'Global' },\n                      { key: 'in_stock', label: 'In Stock' },\n                      { key: 'enquiry', label: 'Enquiry' },\n                    ].map(flag => (\n                      <label key={flag.key} className=\"flex items-center space-x-2 cursor-pointer\">\n                        <input\n                          type=\"checkbox\"\n                          checked={formData[flag.key]}\n                          onChange={(e) => handleInputChange(flag.key, e.target.checked)}\n                          className=\"w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500\"\n                        />\n                        <span className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">\n                          {flag.label}\n                        </span>\n                      </label>\n                    ))}\n                  </div>\n                </div>\n\n                {/* Warehouse Assignment */}\n                <div className=\"bg-slate-50 dark:bg-slate-800/50 p-6 rounded-xl\">\n                  <div className=\"flex items-center space-x-2 mb-4\">\n                    <FaWarehouse className=\"w-5 h-5 text-blue-600\" />\n                    <h3 className=\"text-lg font-semibold text-slate-900 dark:text-white\">\n                      Warehouse Assignment\n                    </h3>\n                  </div>\n                  \n                  {/* Mapping Type */}\n                  <div className=\"mb-4\">\n                    <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2\">\n                      Mapping Type\n                    </label>\n                    <select\n                      value={formData.warehouse_mapping_type}\n                      onChange={(e) => handleInputChange('warehouse_mapping_type', e.target.value)}\n                      className=\"w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:text-white\"\n                    >\n                      <option value=\"nationwide\">üåç Nationwide</option>\n                      <option value=\"zonal_with_fallback\">üè™‚û°Ô∏èüè¢ Zonal + Division</option>\n                      <option value=\"zonal_only\">üè™ Zonal Only</option>\n                      <option value=\"division_only\">üè¢ Division Only</option>\n                    </select>\n                  </div>\n\n                  {/* Warehouse Selection */}\n                  {(formData.warehouse_mapping_type === 'zonal_with_fallback' || \n                    formData.warehouse_mapping_type === 'zonal_only' || \n                    formData.warehouse_mapping_type === 'division_only') && (\n                    <div className=\"space-y-4\">\n                      {/* Primary Warehouses */}\n                      {(formData.warehouse_mapping_type === 'zonal_with_fallback' || \n                        formData.warehouse_mapping_type === 'zonal_only') && (\n                        <div>\n                          <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2\">\n                            Primary Warehouses (Zonal)\n                          </label>\n                          <div className=\"max-h-32 overflow-y-auto space-y-2\">\n                            {zonalWarehouses.map(warehouse => (\n                              <label key={warehouse.id} className=\"flex items-center space-x-2 cursor-pointer\">\n                                <input\n                                  type=\"checkbox\"\n                                  checked={formData.primary_warehouses.includes(warehouse.id)}\n                                  onChange={() => handleWarehouseToggle(warehouse.id, 'primary')}\n                                  className=\"w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500\"\n                                />\n                                <span className=\"text-sm text-slate-700 dark:text-slate-300\">\n                                  {warehouse.name}\n                                </span>\n                              </label>\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      {/* Division Warehouses */}\n                      {(formData.warehouse_mapping_type === 'division_only') && (\n                        <div>\n                          <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2\">\n                            Division Warehouses\n                          </label>\n                          <div className=\"max-h-32 overflow-y-auto space-y-2\">\n                            {divisionWarehouses.map(warehouse => (\n                              <label key={warehouse.id} className=\"flex items-center space-x-2 cursor-pointer\">\n                                <input\n                                  type=\"checkbox\"\n                                  checked={formData.primary_warehouses.includes(warehouse.id)}\n                                  onChange={() => handleWarehouseToggle(warehouse.id, 'primary')}\n                                  className=\"w-4 h-4 text-purple-600 border-slate-300 rounded focus:ring-purple-500\"\n                                />\n                                <span className=\"text-sm text-slate-700 dark:text-slate-300\">\n                                  {warehouse.name}\n                                </span>\n                              </label>\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      {/* Fallback Warehouses */}\n                      {formData.warehouse_mapping_type === 'zonal_with_fallback' && (\n                        <>\n                          <div className=\"flex items-center justify-between\">\n                            <label className=\"flex items-center space-x-2 cursor-pointer\">\n                              <input\n                                type=\"checkbox\"\n                                checked={formData.enable_fallback}\n                                onChange={(e) => handleInputChange('enable_fallback', e.target.checked)}\n                                className=\"w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500\"\n                              />\n                              <span className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">\n                                Enable Fallback\n                              </span>\n                            </label>\n                          </div>\n                          {formData.enable_fallback && (\n                            <div>\n                              <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2\">\n                                Fallback Warehouses (Division)\n                              </label>\n                              <div className=\"max-h-32 overflow-y-auto space-y-2\">\n                                {divisionWarehouses.map(warehouse => (\n                                  <label key={warehouse.id} className=\"flex items-center space-x-2 cursor-pointer\">\n                                    <input\n                                      type=\"checkbox\"\n                                      checked={formData.fallback_warehouses.includes(warehouse.id)}\n                                      onChange={() => handleWarehouseToggle(warehouse.id, 'fallback')}\n                                      className=\"w-4 h-4 text-purple-600 border-slate-300 rounded focus:ring-purple-500\"\n                                    />\n                                    <span className=\"text-sm text-slate-700 dark:text-slate-300\">\n                                      {warehouse.name}\n                                    </span>\n                                  </label>\n                                ))}\n                              </div>\n                            </div>\n                          )}\n                        </>\n                      )}\n                    </div>\n                  )}\n                </div>\n              </div>\n            </div>\n          </div>\n\n          {/* Footer */}\n          <div className=\"p-6 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50\">\n            <div className=\"flex justify-end space-x-3\">\n              <button\n                type=\"button\"\n                onClick={onClose}\n                disabled={loading}\n                className=\"px-6 py-3 text-slate-700 dark:text-slate-300 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors disabled:opacity-50\"\n              >\n                Cancel\n              </button>\n              <button\n                type=\"submit\"\n                disabled={loading}\n                className=\"px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors disabled:opacity-50 flex items-center space-x-2\"\n              >\n                {loading && (\n                  <div className=\"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin\"></div>\n                )}\n                <span>{isEditMode ? 'Update Product' : 'Create Product'}</span>\n              </button>\n            </div>\n          </div>\n        </form>\n      </div>\n    </div>\n  );\n};\n\nexport default ProductModal;